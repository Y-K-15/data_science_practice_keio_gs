# 類似度計算 5方式の実測結果と考察

以下は、現在の `artifacts/song_vectors.parquet`（曲数 1220、全ペア 743,590）に対して、サイドバーにある5方式それぞれで **全曲ペアのcosine類似度**と、各曲の **Top1（自分以外で最大）**、および **Top10の平均類似度（各曲ごとにTop10の類似度平均を取り、その分布）**を計算した結果です。

---

## 計算方法（共通）

- 各方式で特徴行列 `X` を作る（方式により列除外/平均との差分/zscoreなどを適用）
- 各行（曲ベクトル）を L2 正規化して `Xn`
- 類似度行列 `S = Xn @ Xn.T`
- `pair`：`S` の上三角（i<j）の全要素
- `top1`：各行で自分自身を除いた最大値
- `top10 mean(avg)`：各行で上位10件の類似度の平均（これを曲ごとに1値として分布を見る）

---

## 結果サマリ（数値）

|method|pair mean|pair median|pair p95|top1 mean|top1 median|top1 p95|top10 mean(avg)|top10 median(avg)|top10 p95(avg)|pair>0.99|top1>0.99|
|-:|--:|--:|--:|--:|--:|--:|--:|--:|--:|--:|--:|
|raw|0.9729|0.9837|0.9972|0.9984|0.9992|0.9997|0.9971|0.9986|0.9995|0.3196|0.9828|
|no_neutral|0.8967|0.9237|0.9837|0.9941|0.9954|0.9982|0.9900|0.9925|0.9963|0.0158|0.8828|
|mean_center|0.0047|-0.0127|0.8826|0.9518|0.9658|0.9943|0.9205|0.9355|0.9895|0.0005|0.1311|
|zscore|0.0090|-0.0046|0.7590|0.9222|0.9365|0.9806|0.8788|0.8942|0.9623|0.0000|0.0082|
|weighted|0.9729|0.9837|0.9972|0.9984|0.9992|0.9997|0.9971|0.9986|0.9995|0.3196|0.9828|

---

## 考察（この結果から何が言えるか）

### 1) raw は「全ペアの 32% が 0.99超え」＝スコアが飽和している

- `pair>0.99 = 0.3196` はかなり極端です（約3組に1組が 0.99超え）。
- `top1>0.99 = 0.9828` なので、ほぼ全曲が「最も近い曲は0.99台」になります。
- これは、(a) 非負ベクトル + (b) 共通成分（neutral 等）が強い + (c) mean poolingで差が薄まる、が重なって全体が似た方向になっている典型的な挙動です。
- 結果として「順位は作れるが、スコア値そのものは差が見えにくい」状態になっています。

### 2) cosine without neutral は「改善はするが、Top1はまだ高い」

- `pair>0.99` が **0.3196 → 0.0158** と大きく減っています。これは neutral が共通成分としてcosineを押し上げていたことの裏付けです。
- ただし `top1>0.99` は **0.9828 → 0.8828**。Top1は依然として0.99付近が多いです。
- 解釈：**“何でも似てる”問題はかなり緩和されるが、上位はまだ高止まりしやすい**。MVPとしてはかなり現実的な落とし所です。

### 3) mean-centered cosine は「全体平均に対する“偏り”が似ている曲」を拾うので、分布が一気に広がる

- `pair mean ≈ 0`、`pair median < 0` になっています。つまり「反対方向」ペアも大量にいる世界観になります。
- それでも `top1 median = 0.9658` と高いのは、「1,220曲の中からベストを探すと偏りがかなり似た曲が見つかる」ためです（ベスト・オブ・多数効果）。
- 解釈：rawの「絶対的な感情量」ではなく、**“平均的な曲に比べて、どの感情が相対的に強い/弱いか”** の一致で近さを出します。多様性や“らしさ”は上がりやすい一方で、負の類似度など解釈が変わります。

### 4) zscore cosine は「もっとも 0.99 張り付きから解放されている」

- `pair p95 = 0.7590` まで落ちており、rawと比べてスケール感がまるで違います（rawは p95=0.9972）。
- `top1>0.99 = 0.0082`（0.82%）で、0.99台がほぼ消えます。
- 解釈：mean-centerに加えて各感情次元の分散を揃えるので、**“出やすい感情/出にくい感情”のベースレート差を強く打ち消す**方向になります。スコアが見やすくなる反面、小分散列があるとノイズが増幅されやすいので注意が必要です。

### 5) weighted pooling (1-neutral) は、今回の実装だと raw と完全に同じ結果

表で `weighted` が `raw` と完全一致していますが、これは計算上必然です。

- 現実装は「曲ベクトル全体をスカラー `w=(1-neutral)` で掛ける」方式です。
- cosine はスケール不変なので、`cos(w*x, v*y) = cos(x, y)` が常に成り立ち、**順位もスコアも一切変わりません**。
- したがって、現状の `weighted` は比較用の方式として意味を持ちません。

補足（参考）：本来意図されている “(1-neutral)で重み付きmean pooling” を **歌詞行レベル**でやると、rawよりは下がります（例：全ペアmeanが 0.972→0.951、neutral平均も 0.448→0.377）。ただし mean_center/zscore ほど劇的には広がりません。

---

## 「方式を変えるとレコメンドはどれくらい変わるか？」

サンプル200曲で raw の Top10 と比較したときの平均Jaccard（Top10集合の一致率）は概ね以下でした（=結構変わります）：

- raw vs no_neutral：平均 ~0.28
- raw vs mean_center：平均 ~0.34
- raw vs zscore：平均 ~0.24

つまり「スコアの見え方」だけでなく「出てくる曲」もかなり変わります。

---

## 結論（このデータに限って言うなら）

- 0.99 張り付き緩和の効果の強さは概ね `zscore` > `mean_center` > `no_neutral` >> `raw(=weighted)`
- 手堅く副作用が少ないのは `no_neutral`（スコア飽和をかなり減らせる）
- スコアのレンジがきれいで比較しやすいのは `zscore`（ただし小分散列の扱いに注意）
- `weighted` は現状だと `raw` と同じなので、比較用として機能させるには実装変更（行レベルで重み付きpooling）が必要

