このアプリでは、曲ごとの **28次元感情ベクトル**を用いて曲同士の近さを計算し、Top‑K を表示します。

## 共通事項（このアプリの前提）


- 類似度の計算は主に **cosine類似度**（ベクトルの角度の近さ）です
  - `cos(x, y) = (x·y) / (||x|| ||y||)`
- 「raw」以外の方法は、**ベクトルを前処理してから cosine** を計算します

---

## Annoy angular（近似検索）

### 何をしている？
- Annoy の `angular` 距離で **近傍検索（Approximate Nearest Neighbor）** をします。
- `angular` は cosine と単調な関係がある距離で、概ね「cosineに基づく近さ」です。

### 何が嬉しい？
- 曲数が増えたときに、全件の厳密計算より **高速に Top‑K を出しやすい** です。

### 注意点
- Annoy は **近似** なので、厳密なcosine Top‑K と **完全一致しない可能性**があります（設定やデータ規模に依存）。
- Annoy が返すのは「距離」なので、表示用に cosine 相当へ変換しています。

---

## raw cosine

### 何をしている？
- 28次元をそのまま使い、各曲ベクトルを L2 正規化して cosine を計算します。
  - L2 正規化は「正則化」ではなく、ベクトルの長さを 1 に揃える前処理です（`x_norm = x / ||x||`）。
  - 実装上は `app/recommend.py` の `_normalize_matrix` と `get_topk_similar` で、`mat_norm[[query_idx]] @ mat_norm.T` の形で cosine を計算しています。

### 特徴
- 実装がシンプルで、結果の解釈もしやすい（「感情分布が似ている」）。
- ただし `neutral` が大きいデータだと、cosine が高止まりしやすい傾向があります（0.99付近に寄りやすい）。

---

## cosine without neutral

### 何をしている？
- `neutral` 列を除外してから cosine を計算します。

### 狙い
- `neutral` が「どの曲にも入ってしまう共通成分」になっている場合、そこに引っ張られて全体が似て見える問題を緩和します。

### 注意点
- 淡々とした曲（neutralが高い曲）の特徴を一部捨てることになります。

---

## mean-centered cosine

### 何をしている？
- 全曲の平均ベクトル `μ` を引いてから cosine を計算します（`x' = x - μ`）。

### 狙い
- 「どの曲にも共通して入っている成分（ベースライン）」を取り除き、曲ごとの差分にフォーカスします。

### 注意点
- 値が負になることがあります（問題ではありませんが、直感的な解釈は少し変わります）。

---

## zscore cosine

### 何をしている？
- 各感情列ごとに z-score 標準化してから cosine を計算します。
  - `x' = (x - mean) / std`
  - `std` が 0 に近い列は数値が発散しやすいので、下限（ε）を入れています。

### 狙い
- ベースレートが高い列（常に大きめの感情）や、ほぼ定数の列に支配されるのを抑えます。

### 注意点
- ノイズが多い列の影響が強まることがあります（標準化は「ばらつきを同じ重さで扱う」ため）。

---

## weighted pooling (1-neutral)

### 何をしている？（現行実装）
- 曲ベクトルに対して、`w = 1 - neutral` を掛ける前処理を入れています。

### 注意点（重要）
- cosine は L2 正規化するため、**スカラー倍（`w`）は正規化で打ち消されやすく**、多くの場合ランキングがほぼ変わりません。
  - 「neutral が高い行を弱める」という本来の狙いをやるなら、**行レベル（歌詞行）で重み付けしてから曲に集約する**のが素直です。

---

## どれを使えばいい？

迷ったらまずは以下がおすすめです。

1. **raw**（基準）
2. **cosine without neutral**（neutral の影響を見たいとき）
3. **mean-centered** / **zscore**（「共通ベース」を消して差分を見たいとき）
4. **Annoy angular**（曲数が増えてきて速度が気になるとき）
